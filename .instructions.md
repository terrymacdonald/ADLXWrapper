# ADLXWrapper Guide

## Overview

The ADLXWrapper project provides a comprehensive C# wrapper for the AMD Display Library eXtended (ADLX) SDK DLL to allow the C++ DLL to be used within C#. The ADLXWrapper uses SWIG to generate the C# wrappper code. The ADLXWrapper enables application developers to have full access to the ADLX functionality from their C# applications, including GPU management, display control, performance monitoring, and tuning capabilities, and ADLXWrapper avoids the need for the application developers to write their own wrapper DLL.

The ADLXWrapper will primarily be used within the DisplayMagician application to provide access to the AMD GPU and Display Management functiionality so that the DisplayMagician software can control AMD GPUs, and can read and store their settings. 

## Project Tech stack used

### Programming Language

This project is written using the following languages:

#### SWIG Interface file

The SWIG Interface file (ADLXWrapper/ADLXWrapper/ADLXWrapper.i) is written in the SWIG Interface format described here: https://www.swig.org/Doc4.3/SWIGDocumentation.html

#### C#

SWIG generates a C++ Wrapper DLL, and C# binding files (ADLXWrapper/ADLXWrapper/cs_bindings/*.cs)


### SWIG

This project uses the SWIG project (https://www.swig.org/) to create the wrapper DLL. You can find the documentation for SWIG here: https://www.swig.org/Doc4.3/SWIGDocumentation.html
You can also find tutorials on how to use SWIG here: https://www.swig.org/tutorial.html

SWIG is controlled via the SWIG interface file - that is what drives the output that SWIG generates. If you want to add new features and functions to ADLXWrapper, then you need to do so via the SWIG interface file. 

The SWIG interface file for the ADLXWrapper project is ADLXWrapper/ADLXWrapper/ADLXWrapper.i

Once SWIG is run, it will generate various files as an output. The files that matter to us are the outputs of this process:
- ADLXWrapper/ADLXWrapper/x64/Debug/ADLXWrapper.dll - the compiled c++ wrapper DLL
- ADLXWrapper/ADLXWrapper/cs_bindings/*.cs - the C# binding objects that make it far easier to interact with the compiled c++ wrapper DLL

Those two groups of outputs are the only things that application developers will need to copy to use the ADLXWrapper features.

### MSBuild

This project uses the Microsoft Build functions from Microsoft Visual Studio to build this DLL. The idea is that this project should be able to build within Visual Studio as well as build within VSCode. So it is important that any changes will work in both IDEs.

## Project and Code Guidelines

- CRITICAL: Never remove ADLXWrapper functionality without asking for permission to do so! This means NEVER remove code from ADLXWrapper/ADLXWrapper/ADLXWrapper.i withhout asking the user for permission to do so.
- After you have made changes to the ADLXWrapper/ADLXWrapper/ADLXWrapper.i file always make sure that you have not lost any previous ADLXWrapper functionality (unless the user has explicitly asked you to remove the behaviour)
- Never truncate large files. If you find that you have truncated a file and have lost some functionality then restore the file back to where it has the full functionality back and then try again.
- Always use type hints in any language which supports them
- All objects available within the cs_bindings *.cs files MUST be able to be serialised and deserialised to JSON using Newtonsoft.Json library.
- Unit tests are required, and are required to pass before PR passes
  - Unit tests should focus on core functionality
  - Unit test should be made in xUnit.net, and should be tested in .net 8.
- Always follow good security practices
- Use scripts to perform actions when available
- Always update documentation if you change functionality
- When using the terminal to execute commands, always remember you are running within a Powershell Terminal on a Windows 11 PC.
- Do not use older Command Terminal commands - use Powershell commands instead.

## Project Structure

```
ADLXWrapper/
├── ADLXWrapper/              # Native C++ wrapper DLL project
│   ├── ADLXWrapper.i         # SWIG interface definition
│   ├── ADLXWrapper.vcxproj   # Visual Studio project file
│   ├── ADLXQueryInterface.h/cpp # QueryInterface helper functions
│   ├── cs_bindings/*.cs           # Generated SWIG wrapper binding c# classes
│   └── x64/                     # Build output directory
├── ADLXWrapper.Tests/              # ADLXWrapper Uni Test project
│   ├── ADLXWrapper.Tests.csproj   # Visual Studio project file
│   └── *Tests.cs                # Test source files
├── IADLXGPU2Test/              # Old C# test project - NO LONGER IN USE
│   ├── IADLXGPU2Test.csproj     # .NET Framework 4.8 project
│   ├── IADLXGPU2Test_Net8.csproj # .NET 8.0 project
│   ├── bin/Debug/               # Build outputs
│   │   ├── ADLXCSharpBind.dll   # .NET Framework 4.8 output
│   │   └── net8.0/              # .NET 8.0 outputs
│   │       └── IADLXGPU2Test_Net8.dll
│   └── *.cs                     # SWIG wrapper *.cs class files copied from the ADLXWrapper\cs_bindings folder
├── ADLXNativeTest/             # old Native C test applications - NO LONGER IN USE
│   ├── build.bat               # Direct compiler path method
│   ├── build_amd.bat           # AMD vcvars64.bat method
│   ├── build_fixed.bat         # Dynamic compiler detection
│   ├── build_simple.bat        # Simplified AMD official method
│   ├── build_vscode.bat        # VSCode-optimized method
│   └── main.c / main_amd_simple.c # Test source files
├── ADLX/                       # AMD ADLX SDK (downloaded from AMD by the rebuild_adlx.bat script)
├── rebuild_adlx.bat            # Main C++ wrapper build script
├── test_adlx.bat        # C# test build and run script (.NET 8.0)
└── swigwin-4.3.1/                    # SWIG installation directory (it is downloaded by the rebuild_adlx.bat script)
```

## Prerequisites

- Windows 10/11
- Visual Studio 2022 Community (or higher)
- AMD graphics drivers with ADLX support
- Internet connection (for automatic dependency downloads)
- .NET 8.0

**Note:** SWIG 4.3.1 and ADLX SDK are automatically downloaded and installed during the build process.

## Scripts in this Project

### Main Build Scripts

#### `rebuild_adlx.bat`
**Purpose:** Builds the main C++ wrapper DLL (ADLXWrapper.dll)
- Sets up Visual Studio environment using VsDevCmd.bat
- Down
- Builds ADLXWrapper.vcxproj using MSBuild
- Copies output DLL to test directory
- **Output:** 
  - `ADLXWrapper\ADLXWrapper\x64\Debug\ADLXWrapper.dll` - the C++ Wrapper DLL itself
  - `ADLXWrapper\ADLXWrapper\cs_bindings\*.cs` - the C# Binding files that enable the C++ Wrapper DLL to be used

#### `test_adlx.bat`
**Purpose:** Builds and runs the C# test application (.NET 8.0)
- Uses dotnet CLI for .NET 8.0 build and execution
- Verifies .NET 8.0 SDK availability
- Builds IADLXGPU2Test_Net8.csproj using dotnet build
- Runs the compiled test executable using dotnet run
- **Output:** `IADLXGPU2Test\bin\Debug\net8.0\IADLXGPU2Test_Net8.exe`

### Native C Test Scripts (ADLXNativeTest/)

#### `build.bat`
**Purpose:** Direct compiler path method
- Uses hardcoded Visual Studio 2022 compiler path
- Compiles main.c with ADLX helper files
- **Best for:** Systems with known VS2022 installation paths

#### `build_amd.bat`
**Purpose:** AMD vcvars64.bat method
- Uses vcvars64.bat to set up build environment
- Follows AMD's recommended build approach
- **Best for:** Standard AMD development workflow

#### `build_fixed.bat`
**Purpose:** Dynamic compiler detection method
- Automatically finds latest MSVC compiler version
- Most robust method for different VS installations
- **Best for:** Systems with varying VS versions

#### `build_simple.bat`
**Purpose:** Simplified AMD official method
- Uses main_amd_simple.c for basic testing
- Minimal ADLX functionality test
- **Best for:** Diagnosing interface issues

#### `build_vscode.bat`
**Purpose:** VSCode-optimized method
- Designed for VSCode terminal compatibility
- Uses vcvars64.bat with enhanced error checking
- **Best for:** VSCode development environment

## Building the Wrapper

### Option 1: Using VSCode

```batch
# Build the C++ wrapper DLL first
.\rebuild_adlx.bat

# Build and test C# wrapper (.NET 8.0)
.\test_csharp_net8.bat
```

### Option 2: Using Visual Studio

1. Open `ADLXWrapper.sln` in Visual Studio
2. Build the solution (Ctrl+Shift+B)
3. Run the desired test project


## Available Functionality

The wrapper provides access to all ADLX features:

### Display Management
- Display enumeration and properties
- Resolution and refresh rate control
- Color management (gamma, gamut, 3D LUT)
- FreeSync and VRR settings
- HDR and color depth configuration

### GPU Management
- GPU enumeration and information
- Performance monitoring and metrics
- Manual and automatic tuning
- Power management
- Fan control

### 3D Graphics Settings
- Anti-aliasing configuration
- Anisotropic filtering
- Tessellation settings
- Frame rate control
- Image enhancement features

### System Services
- Desktop management
- Application-specific settings
- Event handling and notifications
- I2C communication

## Related Documentation

- [AMD ADLX Documentation](https://gpuopen.com/manuals/adlx/) - Official ADLX SDK documentation
- [AMD ADLX C# Samples](https://gpuopen.com/manuals/adlx/adlx-page_sample_cs/) - Official C# usage examples
- [SWIG Documentation](https://www.swig.org/Doc4.3/SWIGDocumentation.html) - Official SWIG documentation
